---
title: 随机试验中的分层与后分层
category:
  - 因果推断
tag:
  - 学习
  - 因果推断
date: 2025-12-10
order: 4
# 禁止显示页脚
footer: false
---

## SRE

考虑离散的协变量 $X_i\in\{1,2,\ldots,K\}$，对 $n$ 个样本，记 $n_{[k]}=|\{i: X_i=k\}|$ 为这些样本中协变量为 $k$ 的样本个数，这些样本称为第 $k$ 层样本，进而记
$\pi_{[k]}=\dfrac{n_{[k]}}{n}$. 在随机试验中，将所有样本中的 $n_1$ 个分配给处理组，$n_0$ 个分配给对照组. 则可以进一步记
$$
n_{[k]1}=|\{i: X_i=k,Z_i=1\}|,\quad n_{[k]0}=|\{i: X_i=k,Z_i=0\}|, \quad k=1,2,\ldots,K
$$

对每一层的样本，它们全都被分配到处理组或者全都被分入对照组完全有可能发生. 即使一层样本中既有在对照组的也有在处理组的，它们的比例差
$$
\frac{n_{[k]1}}{n_1}-\frac{n_{[k]0}}{n_0}\neq 0
$$
的概率也很高，而且这个差很可能相当大.

::: tip 平均比例差

我们视 $n_{[k]1},n_{[k]0}$ 为随机变量，平均而言
$$
E\left(\frac{n_{[k]1}}{n_1}-\frac{n_{[k]0}}{n_0}\right)=0
$$
要证明这个结论，首先可以计算 $E(n_{[k]1})$. 我们知道 $n_{[k]1}$ 相当于从 $n$ 个样本中抽取 $n_1$ 个进入处理组，其中层次为 $k$ 的样本数量. 从而 $n_{[k]1}\sim \mathrm{HGeom}(n, n_[k], n_1)$，从而
$$
E(n_{[k]1})=\frac{n_1n_{[k]}}{n}
$$
同理
$$
E(n_{[k]0})=\frac{n_0n_{[k]}}{n}
$$
因此
$$
E\left(\frac{n_{[k]1}}{n_1}-\frac{n_{[k]0}}{n_0}\right)=\frac{1}{n_1}\frac{n_1n_{[k]}}{n}-\frac{1}{n_0}\frac{n_0n_{[k]}}{n}=0
$$

:::

当在某些层次，处理组和对照组的比例差别过大时，最终的试验结果将产生两个组别间的协变量不平衡，将进一步影响估计和检验的效果. 为了避免这种协变量不平衡，我们引入**分层随机试验**（Stratified Random Experiments, SRE）.

::: info SRE

固定 $n_{[k]1}$ 或 $n_{[k]0}$，依 $X_i$ 的取值，在 $K$ 个分层内分别执行独立的 CRE，最后汇总处理组和对照组. 这一随机试验称为分层随机试验.

:::

SRE 的不同分组总数为
$$
\prod_{k=1}^K \binom{n_{[k]}}{n_{[k]1}}
$$
且这每一种分组的出现概率都相等. 对于第 $k$ 层，其分配到处理组的样本比例是恒定的，可以记作
$$
e_{[k]}=\frac{n_{[k]1}}{n_{[k]}}
$$
称其为**倾向得分**.

相比 CRE，SRE 的可行分组更少，倾向得分也由随机变为固定值（在每一层上）.

进一步，我们可以在每一层上定义平均因果效应，即
$$
\tau_{[k]}=\frac{1}{n_{[k]}}\sum_{X_i=k}\tau_i
$$
而全样本的平均因果效应为
$$
\tau=\frac{1}{n}\sum_{i=1}^n\tau_i=\frac{1}{n}\sum_{k=1}^K\sum_{X_i=k}\tau_i=\sum_{k=1}^K\pi_{[k]}\tau_{[k]}
$$
即全样本 ATE 是各层 ATE 以倾向得分为权重的加权平均.

## SRE 下的 FRT
